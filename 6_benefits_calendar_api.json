{
  "name": "í˜œíƒ ìº˜ë¦°ë” API (MVP)",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "GET",
        "path": "benefits/calendar",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook_calendar",
      "name": "Webhook: GET /benefits/calendar",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [
        240,
        400
      ],
      "webhookId": "benefits-calendar-api",
      "notes": "í˜œíƒ ìº˜ë¦°ë” ì¡°íšŒ API ì—”ë“œí¬ì¸íŠ¸\n\nQuery Parameters:\n- period: week | month (ê¸°ë³¸: week)\n- userId: ì‚¬ìš©ì ID (ì„ íƒ)\n- category: ì¹´í…Œê³ ë¦¬ í•„í„° (ì„ íƒ)\n- startDate: ì‹œì‘ì¼ YYYY-MM-DD (ì„ íƒ)"
    },
    {
      "parameters": {
        "jsCode": "// Query íŒŒë¼ë¯¸í„° íŒŒì‹± ë° ê²€ì¦\nconst query = $input.item.json.query || {};\n\n// ê¸°ë³¸ê°’ ì„¤ì •\nconst params = {\n  period: query.period || 'week',\n  userId: query.userId || null,\n  category: query.category || null,\n  startDate: query.startDate || new Date().toISOString().split('T')[0]\n};\n\n// ë‚ ì§œ ê³„ì‚°\nconst start = new Date(params.startDate);\nlet end = new Date(start);\n\nif (params.period === 'month') {\n  end.setDate(end.getDate() + 30);\n} else {\n  end.setDate(end.getDate() + 7);\n}\n\nparams.endDate = end.toISOString().split('T')[0];\n\n// ê²€ì¦ ë¡œê·¸\nconsole.log('=== API Request Params ===');\nconsole.log(`Period: ${params.period}`);\nconsole.log(`Date Range: ${params.startDate} ~ ${params.endDate}`);\nif (params.userId) console.log(`User ID: ${params.userId}`);\nif (params.category) console.log(`Category: ${params.category}`);\n\nreturn [{ json: params }];"
      },
      "id": "code_parse_params",
      "name": "Parse Query Params",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        460,
        400
      ],
      "notes": "Query íŒŒë¼ë¯¸í„° íŒŒì‹± ë° ë‚ ì§œ ë²”ìœ„ ê³„ì‚°"
    },
    {
      "parameters": {
        "operation": "read",
        "documentId": {
          "__rl": true,
          "value": "1bxVmRx_dIaQVIxkFEGGEErWDGwJ-XckETNNV6rLlRps",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "Benefits",
          "mode": "name"
        },
        "options": {
          "dataLocationOnSheet": "A1"
        }
      },
      "id": "sheets_read",
      "name": "Google Sheets: Read Benefits",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.2,
      "position": [
        680,
        400
      ],
      "notes": "âš ï¸ ìˆ˜ì • í•„ìš”: YOUR_SPREADSHEET_ID_HEREë¥¼ ì‹¤ì œ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ IDë¡œ êµì²´",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "GOOGLE_SHEETS_CREDENTIAL_ID",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// í˜œíƒ ë°ì´í„° í•„í„°ë§\nconst params = $node[\"Parse Query Params\"].json;\nconst allBenefits = $input.all();\n\nconst filtered = allBenefits.filter(item => {\n  const benefit = item.json;\n  \n  // ë‚ ì§œ ë²”ìœ„ í•„í„°\n  const benefitStart = new Date(benefit.StartDate || benefit.startDate);\n  const benefitEnd = new Date(benefit.EndDate || benefit.endDate);\n  const filterStart = new Date(params.startDate);\n  const filterEnd = new Date(params.endDate);\n  \n  const isInDateRange = benefitEnd >= filterStart && benefitStart <= filterEnd;\n  \n  if (!isInDateRange) return false;\n  \n  // Status í•„í„° (active ë˜ëŠ” scheduledë§Œ)\n  const status = benefit.Status || benefit.status || 'active';\n  if (status === 'expired') return false;\n  \n  // ì¹´í…Œê³ ë¦¬ í•„í„°\n  if (params.category) {\n    const category = benefit.Category || benefit.category || '';\n    if (category !== params.category) return false;\n  }\n  \n  return true;\n});\n\nconsole.log(`í•„í„°ë§ ê²°ê³¼: ì „ì²´ ${allBenefits.length}ê°œ ì¤‘ ${filtered.length}ê°œ ì„ íƒë¨`);\n\nreturn filtered;"
      },
      "id": "code_filter",
      "name": "Filter Benefits",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        900,
        400
      ],
      "notes": "ë‚ ì§œ ë²”ìœ„, ìƒíƒœ, ì¹´í…Œê³ ë¦¬ ê¸°ë°˜ í•„í„°ë§"
    },
    {
      "parameters": {
        "jsCode": "// ìº˜ë¦°ë” í˜•ì‹ìœ¼ë¡œ ë³€í™˜\nconst params = $node[\"Parse Query Params\"].json;\nconst benefits = $input.all();\n\n// ë‚ ì§œë³„ë¡œ ê·¸ë£¹í•‘\nconst calendar = {};\nconst now = new Date();\n\nbenefits.forEach(item => {\n  const benefit = item.json;\n  \n  // ë‚ ì§œ ì •ê·œí™”\n  const startDate = benefit.StartDate || benefit.startDate;\n  const endDate = benefit.EndDate || benefit.endDate;\n  const openTime = benefit.OpenTime || benefit.openTime || '00:00';\n  const closeTime = benefit.CloseTime || benefit.closeTime || '23:59';\n  \n  // ì‹œì‘ì¼ì„ ê¸°ì¤€ìœ¼ë¡œ ê·¸ë£¹í•‘\n  if (!calendar[startDate]) {\n    calendar[startDate] = [];\n  }\n  \n  // ë§Œë£Œ ì„ë°•ë„ ê³„ì‚°\n  const endDateTime = new Date(`${endDate}T${closeTime}:00`);\n  const hoursUntilEnd = (endDateTime - now) / (1000 * 60 * 60);\n  \n  let urgencyTag = null;\n  if (hoursUntilEnd < 2 && hoursUntilEnd > 0) {\n    urgencyTag = 'ğŸ”¥ ë§ˆê°ì„ë°•';\n  } else if (hoursUntilEnd < 24 && hoursUntilEnd > 0) {\n    urgencyTag = 'â° ì˜¤ëŠ˜ë§ˆê°';\n  } else if (startDate === now.toISOString().split('T')[0]) {\n    urgencyTag = 'ğŸ†• ì˜¤ëŠ˜ì˜¤í”ˆ';\n  }\n  \n  // ë”¥ë§í¬ ìƒì„±\n  const deepLink = benefit.DeepLink || benefit.deepLink || '';\n  \n  calendar[startDate].push({\n    id: benefit.ID || benefit.id,\n    provider: benefit.Provider || benefit.provider,\n    name: benefit.Name || benefit.name,\n    category: benefit.Category || benefit.category,\n    startDate: startDate,\n    endDate: endDate,\n    openTime: openTime,\n    closeTime: closeTime,\n    conditions: benefit.Conditions || benefit.conditions || '',\n    deepLink: deepLink,\n    description: benefit.Description || benefit.description || '',\n    value: parseInt(benefit.Value || benefit.value || 0),\n    status: benefit.Status || benefit.status,\n    urgencyTag: urgencyTag,\n    hoursRemaining: Math.round(hoursUntilEnd)\n  });\n});\n\n// ë‚ ì§œìˆœìœ¼ë¡œ ì •ë ¬ëœ ë°°ì—´ë¡œ ë³€í™˜\nconst calendarArray = Object.keys(calendar)\n  .sort()\n  .map(date => ({\n    date: date,\n    dayOfWeek: new Date(date).toLocaleDateString('ko-KR', { weekday: 'short' }),\n    benefitCount: calendar[date].length,\n    benefits: calendar[date].sort((a, b) => {\n      // ê¸´ê¸‰ë„ ìš°ì„  ì •ë ¬\n      if (a.urgencyTag && !b.urgencyTag) return -1;\n      if (!a.urgencyTag && b.urgencyTag) return 1;\n      // ê°€ì¹˜ ë†’ì€ ìˆœ\n      return b.value - a.value;\n    })\n  }));\n\n// ì‘ë‹µ ë°ì´í„° êµ¬ì„±\nconst response = {\n  meta: {\n    period: params.period,\n    startDate: params.startDate,\n    endDate: params.endDate,\n    totalBenefits: benefits.length,\n    category: params.category || 'all',\n    generatedAt: new Date().toISOString()\n  },\n  calendar: calendarArray,\n  summary: {\n    byProvider: {},\n    byCategory: {},\n    totalValue: 0,\n    urgentBenefits: 0\n  }\n};\n\n// ìš”ì•½ í†µê³„ ìƒì„±\nbenefits.forEach(item => {\n  const benefit = item.json;\n  const provider = benefit.Provider || benefit.provider;\n  const category = benefit.Category || benefit.category;\n  const value = parseInt(benefit.Value || benefit.value || 0);\n  \n  response.summary.byProvider[provider] = (response.summary.byProvider[provider] || 0) + 1;\n  response.summary.byCategory[category] = (response.summary.byCategory[category] || 0) + 1;\n  response.summary.totalValue += value;\n});\n\n// ê¸´ê¸‰ í˜œíƒ ì¹´ìš´íŠ¸\nresponse.summary.urgentBenefits = calendarArray.reduce((count, day) => {\n  return count + day.benefits.filter(b => b.urgencyTag).length;\n}, 0);\n\nconsole.log('=== ìº˜ë¦°ë” ìƒì„± ì™„ë£Œ ===');\nconsole.log(`ì´ ${calendarArray.length}ì¼, ${response.meta.totalBenefits}ê°œ í˜œíƒ`);\nconsole.log(`ê¸´ê¸‰ í˜œíƒ: ${response.summary.urgentBenefits}ê°œ`);\n\nreturn [{ json: response }];"
      },
      "id": "code_format_calendar",
      "name": "Format Calendar",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1120,
        400
      ],
      "notes": "ë‚ ì§œë³„ ê·¸ë£¹í•‘, ê¸´ê¸‰ë„ íƒœê·¸, í†µê³„ ìƒì„±"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "application/json; charset=utf-8"
              },
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              },
              {
                "name": "Cache-Control",
                "value": "public, max-age=300"
              }
            ]
          },
          "responseCode": 200
        }
      },
      "id": "respond_success",
      "name": "Respond: Success",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        1340,
        400
      ],
      "notes": "ì„±ê³µ ì‘ë‹µ (200 OK)\n5ë¶„ ìºì‹± ì ìš©"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { \"error\": \"Internal Server Error\", \"message\": $json.message || \"An error occurred\", \"timestamp\": new Date().toISOString() } }}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "application/json; charset=utf-8"
              }
            ]
          },
          "responseCode": 500
        }
      },
      "id": "respond_error",
      "name": "Respond: Error",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        1120,
        600
      ],
      "notes": "ì—ëŸ¬ ì‘ë‹µ (500)"
    }
  ],
  "connections": {
    "Webhook: GET /benefits/calendar": {
      "main": [
        [
          {
            "node": "Parse Query Params",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Query Params": {
      "main": [
        [
          {
            "node": "Google Sheets: Read Benefits",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Sheets: Read Benefits": {
      "main": [
        [
          {
            "node": "Filter Benefits",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter Benefits": {
      "main": [
        [
          {
            "node": "Format Calendar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Calendar": {
      "main": [
        [
          {
            "node": "Respond: Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1",
    "errorWorkflow": "respond_error"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2025-10-13T00:00:00.000Z",
  "versionId": "1"
}

