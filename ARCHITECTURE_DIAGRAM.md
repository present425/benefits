# 🏗️ 혜택 통합 관리 시스템 아키텍처

## 시스템 전체 구조

```
┌─────────────────────────────────────────────────────────────────────┐
│                      혜택 통합 관리 시스템                            │
│                    (Benefits Integration System)                     │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│                          데이터 수집 레이어                           │
└─────────────────────────────────────────────────────────────────────┘

    ┌──────────────┐
    │ Schedule     │
    │ (Daily 5 AM) │
    └──────┬───────┘
           │
           ├─────────────────────────────────────────┐
           │                                         │
           ▼                                         ▼
    ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐
    │  HTTP       │  │  HTTP       │  │  HTTP       │  │  HTTP       │
    │  Request    │  │  Request    │  │  Request    │  │  Request    │
    │  [KT]       │  │  [BC카드]   │  │  [G마켓]    │  │  [넷플릭스] │
    └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘
           │                │                │                │
           ▼                ▼                ▼                ▼
    ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐
    │  Parse      │  │  Parse      │  │  Parse      │  │  Parse      │
    │  KT Data    │  │  BC Data    │  │  G마켓 Data │  │  넷플릭스   │
    └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘
           │                │                │                │
           └────────────────┴────────┬───────┴────────────────┘
                                     ▼
                            ┌─────────────────┐
                            │  Merge All      │
                            │  Benefits       │
                            └────────┬────────┘
                                     ▼
                            ┌─────────────────┐
                            │  Deduplicate    │
                            │  & Clean        │
                            └────────┬────────┘
                                     ▼
                            ┌─────────────────┐
                            │  Google Sheets  │
                            │  (Benefits DB)  │
                            └─────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│                          API 서비스 레이어                            │
└─────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────┐        ┌──────────────────────────────┐
│  혜택 캘린더 API (MVP)        │        │  AI 추천 API (향후)          │
└──────────────────────────────┘        └──────────────────────────────┘

     ┌──────────────┐                        ┌──────────────┐
     │  Webhook     │                        │  Webhook     │
     │  GET /...    │                        │  POST /...   │
     └──────┬───────┘                        └──────┬───────┘
            │                                       │
            ▼                                       ▼
     ┌──────────────┐                        ┌──────────────┐
     │  Parse       │                        │  Parse       │
     │  Params      │                        │  Request     │
     └──────┬───────┘                        └──────┬───────┘
            │                                       │
            ▼                                       ├──────────┐
     ┌──────────────┐                              │          │
     │  Google      │                              ▼          ▼
     │  Sheets      │                      ┌──────────┐  ┌──────────┐
     │  Read        │                      │  Sheets  │  │  Sheets  │
     └──────┬───────┘                      │  User    │  │  Benefits│
            │                              │  Payments│  │          │
            ▼                              └────┬─────┘  └────┬─────┘
     ┌──────────────┐                          │             │
     │  Filter      │                          └──────┬──────┘
     │  Benefits    │                                 ▼
     └──────┬───────┘                          ┌──────────────┐
            │                                  │  Build AI    │
            ▼                                  │  Prompt      │
     ┌──────────────┐                          └──────┬───────┘
     │  Format      │                                 ▼
     │  Calendar    │                          ┌──────────────┐
     └──────┬───────┘                          │  OpenAI      │
            │                                  │  GPT-4       │
            ▼                                  └──────┬───────┘
     ┌──────────────┐                                 ▼
     │  Respond     │                          ┌──────────────┐
     │  JSON        │                          │  Parse AI    │
     └──────────────┘                          │  Response    │
                                               └──────┬───────┘
                                                      ▼
                                               ┌──────────────┐
                                               │  Respond     │
                                               │  JSON        │
                                               └──────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│                        데이터 저장소 레이어                           │
└─────────────────────────────────────────────────────────────────────┘

        ┌──────────────────────────────────────────────┐
        │         Google Sheets (MVP Database)         │
        ├──────────────────────────────────────────────┤
        │                                              │
        │  📊 Benefits (혜택 마스터)                   │
        │  - 13개 샘플 데이터                          │
        │  - ID, Provider, Name, Category...          │
        │                                              │
        │  📊 UserPayments (결제 이력)                 │
        │  - 10개 샘플 데이터                          │
        │  - UserID, Date, Category, Amount...        │
        │                                              │
        └──────────────────────────────────────────────┘
```

---

## 데이터 흐름도

### 1️⃣ 혜택 데이터 수집 (Daily)

```
[외부 웹사이트]
     │
     │ HTTP Request
     ▼
[HTML Response]
     │
     │ HTML Parsing
     ▼
[구조화된 데이터]
     │
     │ Deduplication
     ▼
[Google Sheets]
```

**실행 주기**: 매일 오전 5시
**소요 시간**: 약 2-3분 (4개 소스)
**데이터량**: 평균 20-30개/일

### 2️⃣ 혜택 캘린더 조회 (On-Demand)

```
[클라이언트 요청]
  GET /benefits/calendar?period=week&category=쇼핑
     │
     ▼
[파라미터 검증]
  period: week
  category: 쇼핑
  startDate: 2025-10-13
  endDate: 2025-10-20
     │
     ▼
[Google Sheets 조회]
  WHERE StartDate <= 2025-10-20
    AND EndDate >= 2025-10-13
    AND Status IN ('active', 'scheduled')
    AND Category = '쇼핑'
     │
     ▼
[긴급도 계산 & 정렬]
  - 오픈/마감 임박 태그 추가
  - 혜택 가치 순 정렬
  - 날짜별 그룹핑
     │
     ▼
[JSON 응답]
  {
    "meta": {...},
    "calendar": [...],
    "summary": {...}
  }
```

**응답 시간**: < 2초
**캐싱**: 5분 (Cache-Control)

### 3️⃣ AI 추천 (On-Demand)

```
[클라이언트 요청]
  POST /benefits/recommend
  { userId: "U001", context: "shopping" }
     │
     ▼
[사용자 데이터 조회]
  - 결제 이력 (UserPayments)
  - 현재 사용 가능한 혜택 (Benefits)
     │
     ▼
[AI 프롬프트 생성]
  - 소비 패턴 분석
  - 혜택 리스트 정리
  - 추천 요청 프롬프트
     │
     ▼
[OpenAI API 호출]
  GPT-4 분석 (약 2-3초)
     │
     ▼
[응답 파싱 & 포맷팅]
  - TOP 3 추천
  - 이유 설명
  - 대체 플랜
     │
     ▼
[JSON 응답]
  {
    "recommendations": [...],
    "insights": "...",
    "alternativePlan": "..."
  }
```

**응답 시간**: 3-5초 (OpenAI 포함)
**비용**: 약 $0.01/요청 (GPT-4)

---

## 기술 스택

### 백엔드 & 자동화
```
┌──────────────────────────────────┐
│  n8n (Workflow Automation)       │
│  - 버전: Latest                   │
│  - 실행 환경: Docker              │
│  - 포트: 5678                     │
└──────────────────────────────────┘
```

### 데이터베이스 (MVP)
```
┌──────────────────────────────────┐
│  Google Sheets                   │
│  - 무료 티어                      │
│  - 최대 40,000행                  │
│  - OAuth 2.0 인증                 │
└──────────────────────────────────┘
```

### AI & ML
```
┌──────────────────────────────────┐
│  OpenAI GPT-4                    │
│  - 추천 엔진                      │
│  - 자연어 분석                    │
│  - 비용: $0.03/1K tokens (input) │
└──────────────────────────────────┘
```

### 웹 크롤링
```
┌──────────────────────────────────┐
│  HTTP Request (n8n 내장)         │
│  - User-Agent 설정                │
│  - Timeout 관리                   │
│  - Retry 로직                     │
└──────────────────────────────────┘
```

---

## 보안 아키텍처

```
┌─────────────────────────────────────────────────────┐
│                   보안 레이어                        │
└─────────────────────────────────────────────────────┘

┌──────────────────┐
│  클라이언트       │
└────────┬─────────┘
         │ HTTPS (향후)
         ▼
┌──────────────────┐
│  n8n Webhook     │
│  - CORS 허용     │
│  - Rate Limiting │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│  인증 레이어      │
│  (향후 구현)     │
│  - API Key       │
│  - JWT Token     │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│  Google Sheets   │
│  - OAuth 2.0     │
│  - 읽기 권한     │
└──────────────────┘
```

### 현재 보안 상태
- ✅ Google OAuth 2.0 인증
- ✅ 환경변수로 API 키 관리
- ⚠️ Webhook 공개 엔드포인트 (인증 없음)
- ⚠️ Rate Limiting 미적용

### 권장 보안 강화 (프로덕션)
1. **API Key 인증** 추가
2. **Rate Limiting** (10 req/min per IP)
3. **HTTPS** 적용
4. **CORS** 설정 강화
5. **로그 모니터링** (Suspicious activity)

---

## 확장성 고려사항

### 현재 한계 (MVP)

| 항목 | 현재 | 프로덕션 목표 |
|------|------|---------------|
| 데이터베이스 | Google Sheets (40K행) | PostgreSQL (무제한) |
| 동시 접속 | ~10명 | 1,000명+ |
| 응답 시간 | 2초 | 200ms |
| 캐싱 | 5분 HTTP 캐시 | Redis + CDN |
| 모니터링 | n8n 로그 | Grafana + Sentry |

### 확장 로드맵

**Phase 1: MVP (현재)**
```
n8n + Google Sheets
→ 10-100 사용자
→ 프로토타입 검증
```

**Phase 2: 베타 서비스**
```
n8n + PostgreSQL
→ 100-1,000 사용자
→ Redis 캐싱 추가
→ 인증/인가 시스템
```

**Phase 3: 프로덕션**
```
Microservices + Kubernetes
→ 10,000+ 사용자
→ Load Balancing
→ Auto Scaling
→ Multi-Region
```

---

## 모니터링 & 로깅

### 현재 모니터링 (n8n 내장)

```
┌──────────────────────────────────┐
│  n8n Execution Logs              │
│  - 워크플로우 성공/실패           │
│  - 노드별 실행 시간               │
│  - 에러 스택트레이스              │
└──────────────────────────────────┘
```

### 향후 모니터링 (프로덕션)

```
┌─────────────────────────────────────────────┐
│               모니터링 스택                  │
├─────────────────────────────────────────────┤
│                                             │
│  📊 Grafana                                 │
│    - 실시간 대시보드                        │
│    - API 응답 시간                          │
│    - 에러율 추이                            │
│                                             │
│  🔍 Prometheus                              │
│    - 메트릭 수집                            │
│    - 알림 규칙                              │
│                                             │
│  🐛 Sentry                                  │
│    - 에러 추적                              │
│    - 사용자 피드백                          │
│                                             │
│  📝 ELK Stack                               │
│    - 로그 집계                              │
│    - 검색 & 분석                            │
│                                             │
└─────────────────────────────────────────────┘
```

---

## 비용 구조 (월간 예상)

### MVP 단계 (현재)

| 항목 | 비용 | 비고 |
|------|------|------|
| Google Sheets | 무료 | 개인 계정 사용 |
| n8n (Self-hosted) | 무료 | Docker 로컬 실행 |
| OpenAI API | $10-30 | 사용량에 따라 변동 |
| 서버 (로컬) | 무료 | 개발 환경 |
| **총합** | **$10-30** | MVP 테스트 가능 |

### 베타 서비스 (100-1,000 사용자)

| 항목 | 비용 | 비고 |
|------|------|------|
| PostgreSQL (Supabase) | $25 | Pro Plan |
| n8n Cloud | $0-50 | Self-hosted 가능 |
| OpenAI API | $100-300 | 추천 API 사용 증가 |
| AWS/GCP 서버 | $50-100 | t3.medium 급 |
| Redis Cache | $15 | ElastiCache |
| **총합** | **$190-490** | 월 1,000명 활성 사용자 |

### 프로덕션 (10,000+ 사용자)

| 항목 | 비용 | 비고 |
|------|------|------|
| Database (PostgreSQL) | $200+ | 스케일링 필요 |
| Kubernetes Cluster | $500+ | Multi-node |
| OpenAI API | $1,000+ | 대량 추천 요청 |
| CDN & Load Balancer | $100+ | CloudFlare Pro |
| Monitoring & Logging | $100+ | Grafana Cloud |
| **총합** | **$1,900+** | 스케일 업 필요 시 증가 |

---

## 성능 벤치마크 목표

### 현재 성능 (MVP)

| 메트릭 | 현재 | 목표 (베타) | 목표 (프로덕션) |
|--------|------|-------------|-----------------|
| 캘린더 API 응답 | 2초 | 500ms | 200ms |
| AI 추천 응답 | 5초 | 3초 | 2초 |
| 동시 요청 처리 | 10 | 100 | 1,000+ |
| 가용성 (Uptime) | 95% | 99% | 99.9% |
| 크롤링 성공률 | 80% | 95% | 99% |

---

## 다음 단계

1. ✅ **아키텍처 설계 완료**
2. ✅ **MVP 워크플로우 구축**
3. ⏳ **실제 크롤링 로직 구현**
4. ⏳ **프론트엔드 개발**
5. ⏳ **베타 테스트**
6. ⏳ **프로덕션 배포**

---

**문서 버전**: 1.0
**최종 업데이트**: 2025-10-13

